<!DOCTYPE html>
<html>
<head>
    <title>CKD Firebase ë””ë²„ê¹… ë„êµ¬</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; }
        .error { background: #ffe6e6; color: #d00; }
        .success { background: #e6ffe6; color: #080; }
        button { padding: 10px 15px; margin: 5px; background: #007cba; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #005a87; }
        pre { background: #f0f0f0; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .info-box { background: #e7f3ff; padding: 10px; border-left: 4px solid #007cba; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ğŸ”§ CKD Firebase ë””ë²„ê¹… ë„êµ¬</h1>
    
    <div class="info-box">
        <strong>ì‚¬ìš©ë²•:</strong> ì´ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ Firebase ì—°ê²°, ë°ì´í„° ì €ì¥/ì½ê¸°ë¥¼ ë‹¨ê³„ë³„ë¡œ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </div>

    <div class="section">
        <h2>ğŸ“‹ í˜„ì¬ Firebase ì„¤ì •</h2>
        <div id="config-info" class="result">ë¡œë”© ì¤‘...</div>
    </div>

    <div class="section">
        <h2>ğŸ”— 1ë‹¨ê³„: Firebase ì—°ê²° í…ŒìŠ¤íŠ¸</h2>
        <button onclick="testConnection()">ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
        <div id="connection-result" class="result"></div>
    </div>

    <div class="section">
        <h2>ğŸ“ 2ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ë°ì´í„° ì €ì¥</h2>
        <button onclick="testWrite()">í…ŒìŠ¤íŠ¸ ë°ì´í„° ì €ì¥</button>
        <div id="write-result" class="result"></div>
    </div>

    <div class="section">
        <h2>ğŸ“– 3ë‹¨ê³„: ë°ì´í„° ì½ê¸° í…ŒìŠ¤íŠ¸</h2>
        <button onclick="testRead()">ë°ì´í„° ì½ê¸°</button>
        <button onclick="testRealtime()">ì‹¤ì‹œê°„ êµ¬ë… í…ŒìŠ¤íŠ¸</button>
        <div id="read-result" class="result"></div>
    </div>

    <div class="section">
        <h2>ğŸ—„ï¸ 4ë‹¨ê³„: LocalStorage í™•ì¸</h2>
        <button onclick="checkLocalStorage()">LocalStorage í™•ì¸</button>
        <button onclick="clearLocalStorage()">LocalStorage ì´ˆê¸°í™”</button>
        <div id="storage-result" class="result"></div>
    </div>

    <div class="section">
        <h2>ğŸŒ 5ë‹¨ê³„: í™˜ê²½ ì •ë³´</h2>
        <button onclick="checkEnvironment()">í™˜ê²½ ì •ë³´ í™•ì¸</button>
        <div id="env-result" class="result"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            onSnapshot,
            query,
            orderBy,
            Timestamp 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase ì„¤ì • (ì‹¤ì œ í”„ë¡œì íŠ¸ì™€ ë™ì¼)
        const firebaseConfig = {
            apiKey: "AIzaSyDP47zfIOQ-7HH9GVYw4oe3-knQBfENTlk",
            authDomain: "ckd-app-001.firebaseapp.com",
            projectId: "ckd-app-001",
            storageBucket: "ckd-app-001.firebasestorage.app",
            messagingSenderId: "975049362785",
            appId: "1:975049362785:web:8a511219b5234236e7a183",
            measurementId: "G-LYV8NSVBMM",
        };

        let app, db;
        let unsubscribe = null;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            
            document.getElementById('config-info').innerHTML = `
                <div class="success">âœ… Firebase ì´ˆê¸°í™” ì„±ê³µ</div>
                <pre>${JSON.stringify(firebaseConfig, null, 2)}</pre>
            `;
        } catch (error) {
            document.getElementById('config-info').innerHTML = `
                <div class="error">âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}</div>
            `;
        }

        // ì „ì—­ í•¨ìˆ˜ë“¤
        window.testConnection = async function() {
            const resultDiv = document.getElementById('connection-result');
            resultDiv.innerHTML = 'ğŸ”„ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...';
            
            try {
                // ê°„ë‹¨í•œ ì½ê¸° í…ŒìŠ¤íŠ¸ë¡œ ì—°ê²° í™•ì¸
                const testQuery = query(collection(db, 'submissions'));
                await getDocs(testQuery);
                
                resultDiv.innerHTML = `
                    <div class="success">âœ… Firebase ì—°ê²° ì„±ê³µ</div>
                    <div>í”„ë¡œì íŠ¸ ID: ${firebaseConfig.projectId}</div>
                    <div>ì—°ê²° ì‹œê°„: ${new Date().toLocaleString()}</div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">âŒ ì—°ê²° ì‹¤íŒ¨: ${error.message}</div>
                    <pre>${error.stack}</pre>
                `;
            }
        };

        window.testWrite = async function() {
            const resultDiv = document.getElementById('write-result');
            resultDiv.innerHTML = 'ğŸ”„ ë°ì´í„° ì €ì¥ ì¤‘...';
            
            try {
                const testData = {
                    status: 'pending',
                    submittedAt: Timestamp.now(),
                    projectInfo: {
                        companyName: 'ë””ë²„ê·¸ í…ŒìŠ¤íŠ¸ íšŒì‚¬',
                        constructionName: 'ì—°ê²° í…ŒìŠ¤íŠ¸ í”„ë¡œì íŠ¸',
                        location: 'ì„œìš¸',
                        contactPerson: 'í…ŒìŠ¤í„°'
                    },
                    safetyTraining: { completed: true, completionDate: null },
                    riskAssessment: [],
                    workPermit: {},
                    safetyPledge: { agreements: {}, agreeToAll: true, name: 'í…ŒìŠ¤í„°', signature: '' },
                    debugInfo: {
                        createdBy: 'debug-tool',
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        url: window.location.href
                    }
                };

                const docRef = await addDoc(collection(db, 'submissions'), testData);
                
                resultDiv.innerHTML = `
                    <div class="success">âœ… ë°ì´í„° ì €ì¥ ì„±ê³µ</div>
                    <div>ë¬¸ì„œ ID: ${docRef.id}</div>
                    <div>ì €ì¥ ì‹œê°„: ${new Date().toLocaleString()}</div>
                    <div>âš ï¸ <strong>ì¤‘ìš”:</strong> ì´ì œ Firebase Consoleì—ì„œ submissions ì»¬ë ‰ì…˜ì„ í™•ì¸í•˜ì„¸ìš”!</div>
                    <a href="https://console.firebase.google.com/project/ckd-app-001/firestore/data" target="_blank">
                        ğŸ”— Firebase Consoleì—ì„œ í™•ì¸í•˜ê¸°
                    </a>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">âŒ ì €ì¥ ì‹¤íŒ¨: ${error.message}</div>
                    <pre>${error.stack}</pre>
                `;
            }
        };

        window.testRead = async function() {
            const resultDiv = document.getElementById('read-result');
            resultDiv.innerHTML = 'ğŸ”„ ë°ì´í„° ì½ê¸° ì¤‘...';
            
            try {
                const q = query(collection(db, 'submissions'), orderBy('submittedAt', 'desc'));
                const querySnapshot = await getDocs(q);
                
                const docs = [];
                querySnapshot.forEach((doc) => {
                    docs.push({ id: doc.id, ...doc.data() });
                });

                resultDiv.innerHTML = `
                    <div class="success">âœ… ë°ì´í„° ì½ê¸° ì„±ê³µ</div>
                    <div>ì´ ${docs.length}ê°œ ë¬¸ì„œ ë°œê²¬</div>
                    <div>ì½ê¸° ì‹œê°„: ${new Date().toLocaleString()}</div>
                    <details>
                        <summary>ğŸ“‹ ë¬¸ì„œ ëª©ë¡ ë³´ê¸°</summary>
                        <pre>${JSON.stringify(docs.map(d => ({
                            id: d.id,
                            company: d.projectInfo?.companyName,
                            status: d.status,
                            submittedAt: d.submittedAt?.toDate?.()?.toLocaleString() || d.submittedAt
                        })), null, 2)}</pre>
                    </details>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">âŒ ì½ê¸° ì‹¤íŒ¨: ${error.message}</div>
                    <pre>${error.stack}</pre>
                `;
            }
        };

        window.testRealtime = function() {
            const resultDiv = document.getElementById('read-result');
            
            if (unsubscribe) {
                unsubscribe();
                unsubscribe = null;
                resultDiv.innerHTML += '<div>ğŸ”„ ì‹¤ì‹œê°„ êµ¬ë… ì¤‘ì§€ë¨</div>';
                return;
            }

            resultDiv.innerHTML = 'ğŸ”„ ì‹¤ì‹œê°„ êµ¬ë… ì‹œì‘...';
            
            try {
                const q = query(collection(db, 'submissions'), orderBy('submittedAt', 'desc'));
                unsubscribe = onSnapshot(q, 
                    (querySnapshot) => {
                        const docs = [];
                        querySnapshot.forEach((doc) => {
                            docs.push({ id: doc.id, ...doc.data() });
                        });

                        resultDiv.innerHTML = `
                            <div class="success">ğŸ“¡ ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹ </div>
                            <div>ì´ ${docs.length}ê°œ ë¬¸ì„œ</div>
                            <div>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleString()}</div>
                            <button onclick="testRealtime()">êµ¬ë… ì¤‘ì§€</button>
                            <details>
                                <summary>ğŸ“‹ ì‹¤ì‹œê°„ ë°ì´í„° ë³´ê¸°</summary>
                                <pre>${JSON.stringify(docs.map(d => ({
                                    id: d.id,
                                    company: d.projectInfo?.companyName,
                                    status: d.status
                                })), null, 2)}</pre>
                            </details>
                        `;
                    },
                    (error) => {
                        resultDiv.innerHTML = `
                            <div class="error">âŒ ì‹¤ì‹œê°„ êµ¬ë… ì‹¤íŒ¨: ${error.message}</div>
                        `;
                    }
                );
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">âŒ ì‹¤ì‹œê°„ êµ¬ë… ì„¤ì • ì‹¤íŒ¨: ${error.message}</div>
                `;
            }
        };

        window.checkLocalStorage = function() {
            const resultDiv = document.getElementById('storage-result');
            
            try {
                const submissions = localStorage.getItem('ckd-submissions');
                const lastSync = localStorage.getItem('ckd-last-sync');
                
                if (submissions) {
                    const parsed = JSON.parse(submissions);
                    resultDiv.innerHTML = `
                        <div class="success">âœ… LocalStorageì— ë°ì´í„° ë°œê²¬</div>
                        <div>ë°ì´í„° ê°œìˆ˜: ${parsed.length}ê°œ</div>
                        <div>ë§ˆì§€ë§‰ ë™ê¸°í™”: ${lastSync || 'ì—†ìŒ'}</div>
                        <details>
                            <summary>ğŸ“‹ LocalStorage ë°ì´í„° ë³´ê¸°</summary>
                            <pre>${JSON.stringify(parsed.map(d => ({
                                id: d.id,
                                company: d.projectInfo?.companyName,
                                status: d.status
                            })), null, 2)}</pre>
                        </details>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">âŒ LocalStorageì— ë°ì´í„° ì—†ìŒ</div>
                        <div>í‚¤ 'ckd-submissions'ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">âŒ LocalStorage í™•ì¸ ì‹¤íŒ¨: ${error.message}</div>
                `;
            }
        };

        window.clearLocalStorage = function() {
            localStorage.removeItem('ckd-submissions');
            localStorage.removeItem('ckd-last-sync');
            document.getElementById('storage-result').innerHTML = `
                <div class="success">âœ… LocalStorage ì´ˆê¸°í™” ì™„ë£Œ</div>
            `;
        };

        window.checkEnvironment = function() {
            const resultDiv = document.getElementById('env-result');
            
            resultDiv.innerHTML = `
                <div class="success">ğŸŒ í™˜ê²½ ì •ë³´</div>
                <pre>URL: ${window.location.href}
ë„ë©”ì¸: ${window.location.hostname}
í”„ë¡œí† ì½œ: ${window.location.protocol}
í¬íŠ¸: ${window.location.port || 'ê¸°ë³¸'}
User Agent: ${navigator.userAgent}
í˜„ì¬ ì‹œê°„: ${new Date().toISOString()}
íƒ€ì„ì¡´: ${Intl.DateTimeFormat().resolvedOptions().timeZone}

Firebase ì„¤ì •:
- Project ID: ${firebaseConfig.projectId}
- Auth Domain: ${firebaseConfig.authDomain}
- API Key: ${firebaseConfig.apiKey.substring(0, 20)}...

LocalStorage ì§€ì›: ${localStorage ? 'âœ…' : 'âŒ'}
IndexedDB ì§€ì›: ${indexedDB ? 'âœ…' : 'âŒ'}</pre>
            `;
        };
    </script>
</body>
</html>
